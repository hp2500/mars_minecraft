---
title: "Process Data Analysis"
author: "Heinrich Peters"
date: "4/10/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# MAC
knitr::opts_knit$set(root.dir = '/Users/hp2500/Google Drive/STUDY/Columbia/Research/Minecraft/Data')

```



# Import Libraries
```{r, results = "hide", message=FALSE}

library(tidyverse)
library(dplyr)
library(tidyr)
library(caret)
library(glmnet)

```

# Import Data
```{r, results = "hide", message=FALSE}

pc <- read.csv('pc.csv')
mr <- read.csv('mr.csv')
sc <- read.csv('sc.csv')
df_all <- read.csv('df_all.csv')

```





# Analyze Process Data 

## Exctract Process Features - SC
```{r}

variables = c('id', 'item', 'time_taken', 'distance_travelled', 
         'xPos', 'yPos', 'zPos', 'Pitch', 'Yaw', 'ray.x.', 'ray.y.', 
         'ray.z.', 'ray.distance.', 'distance_goal', 'looking_model', 
         'looking_goal', 'steps', 'correctBlocks', 'incorrectBlocks', 
         'answer')

sc_feat <- sc %>% 
  #mutate(id = as.factor(id)) %>%
  dplyr::select(all_of(variables)) %>% 
  #filter(item != 1 & item != 2) %>%
  dplyr::group_by(id) %>%
  dplyr::summarize(distance_travelled = max(as.numeric(distance_travelled), na.rm = T),
            xPos_range = diff(range(as.numeric(xPos), na.rm = T)), 
            xPos_mean = mean(as.numeric(xPos), na.rm = T), 
            xPos_sd = sd(as.numeric(xPos), na.rm = T), 
            yPos_range = diff(range(as.numeric(yPos), na.rm = T)), 
            yPos_mean = mean(as.numeric(yPos), na.rm = T), 
            yPos_sd = sd(as.numeric(yPos), na.rm = T), 
            zPos_range = diff(range(as.numeric(zPos), na.rm = T)),
            zPos_mean = mean(as.numeric(zPos), na.rm = T), 
            zPos_sd = sd(as.numeric(zPos), na.rm = T), 
            pitch_range = diff(range(as.numeric(Pitch), na.rm = T)),
            pitch_mean = mean(as.numeric(Pitch), na.rm = T), 
            pitch_sd = sd(as.numeric(Pitch), na.rm = T), 
            yaw_range = diff(range(as.numeric(Yaw), na.rm = T)),
            yaw_mean = mean(as.numeric(Yaw), na.rm = T),
            yaw_sd = sd(as.numeric(Yaw), na.rm = T),
            ray_x_range = diff(range(as.numeric(ray.x.), na.rm = T)),
            ray_x_mean = mean(as.numeric(ray.x.), na.rm = T),
            ray_x_sd = sd(as.numeric(ray.x.), na.rm = T),
            ray_y_range = diff(range(as.numeric(ray.y.), na.rm = T)),
            ray_z_mean = mean(as.numeric(ray.z.), na.rm = T),
            ray_z_sd = sd(as.numeric(ray.z.), na.rm = T),
            ray_dist_range = diff(range(as.numeric(ray.distance.), na.rm = T)),
            ray_dist_mean = mean(as.numeric(ray.distance.), na.rm = T), 
            ray_dist_sd = sd(as.numeric(ray.distance.), na.rm = T), 
            looking_model = max(as.numeric(looking_model), na.rm = T),
            looking_goal = max(as.numeric(looking_goal), na.rm = T),
            looking_ratio = looking_model/looking_goal) %>%
  ungroup()

dim(sc_feat)

 
sc_feat_item <- sc %>% 
  dplyr::select(all_of(variables)) %>% 
  filter(item != 1 & item != 2) %>%
  dplyr::group_by(id, item) %>%
  dplyr::summarise(distance_travelled = max(as.numeric(distance_travelled), na.rm = T),
            xPos_range = diff(range(as.numeric(xPos), na.rm = T)), 
            xPos_mean = mean(as.numeric(xPos), na.rm = T), 
            yPos_range = diff(range(as.numeric(yPos), na.rm = T)), 
            yPos_mean = mean(as.numeric(yPos), na.rm = T), 
            zPos_range = diff(range(as.numeric(zPos), na.rm = T)),
            zPos_mean = mean(as.numeric(zPos), na.rm = T), 
            pitch_range = diff(range(as.numeric(Pitch), na.rm = T)),
            pitch_mean = mean(as.numeric(Pitch), na.rm = T), 
            yaw_range = diff(range(as.numeric(Yaw), na.rm = T)),
            yaw_mean = mean(as.numeric(Yaw), na.rm = T),
            ray_x_range = diff(range(as.numeric(ray.x.), na.rm = T)),
            ray_x_mean = mean(as.numeric(ray.x.), na.rm = T),
            ray_y_range = diff(range(as.numeric(ray.y.), na.rm = T)),
            ray_z_mean = mean(as.numeric(ray.z.), na.rm = T),
            ray_dist_range = diff(range(as.numeric(ray.distance.), na.rm = T)),
            ray_dist_mean = mean(as.numeric(ray.distance.), na.rm = T), 
            looking_model = max(as.numeric(looking_model), na.rm = T),
            looking_goal = max(as.numeric(looking_goal), na.rm = T),
            looking_ratio = looking_model/looking_goal) %>% 
  ungroup()

dim(sc_feat_item)


# spread variables by item 
sc_feat_item_wide = sc_feat_item %>% dplyr::select(id) %>% unique()

for (i in names(sc_feat_item)[3:length(sc_feat_item)]){
  
  long_temp <- sc_feat_item %>% dplyr::select(id, item, all_of(i)) 
  wide_temp <- long_temp %>% tidyr::spread(key=item, value = i) 
  names(wide_temp) <- paste("sc",names(wide_temp), i, sep='_')
  names(wide_temp)[1] <- "id"
  sc_feat_item_wide = sc_feat_item_wide %>% inner_join(wide_temp, by="id")
}


dim(sc_feat_item_wide)


# sc_feat_item_wide %>% is.na() %>% colSums()


```

## Merge data
```{r}

sc_feat_all <- sc_feat %>% inner_join(df_all, by="id") 
#sc_feat_all_item_wide <- sc_feat_item_wide %>% inner_join(df_all, by="id") 



```

## Exploratory analyses
```{r}

# correlation table 
sc_feat_all_cor <- sc_feat_all %>% dplyr::select(-id) %>% 
  cor() %>% 
  as.data.frame() %>% 
  rownames_to_column() %>% 
  filter(rowname %in% c("pc", "mr", "sc", "VKMR", "SPM"))

sc_feat_all_cor


# correlation table 
sc_feat_all_item_wide_cor <- sc_feat_all_item_wide %>% dplyr::select(-id) %>% 
  cor(use="complete.obs") %>% 
  as.data.frame() %>% 
  rownames_to_column() %>% 
  filter(rowname %in% c("pc", "mr", "sc", "VKMR", "SPM"))

sc_feat_all_item_wide_cor




```



## Build function for nested CV
```{r}

nested_cv <- function(data, target, inner_method = 'cv', inner_number = 10,
                      outer_method = 'kfold', outer_number = 10){
  
            
  # cross validation strategy for inner loop
  ctrl <- trainControl(method = "cv", number = 10)
  
  # parameter grid for elastic net
  enet_grid <- expand.grid(.lambda = seq(.05, 1, length = 10),
                      .alpha = seq(.05, 1, length = 10))
  
  # parameter grid for random forest
  rf_grid <- data.frame(.mtry = 2:(ncol(training) - 1L))
  
  
  # create empty list for results
  cv_results <- list('enet' = NULL, 'rf' = NULL)
  
  # create folds for outer k-fold cv
  kfolds <- rep(1:outer_number, length.out = nrow(data)) %>% sample(replace = F)

  # nested cross validation loop 
  for (i in 1:outer_number){
    
    print(paste('Outer loop:', i))
    
    # train test split outer loop
    if (outer_method == 'monte_carlo'){
    in_train <- createDataPartition(y = data[[target]],
                                  p = 0.9, list = FALSE)
    }
    
    if (outer_method == 'kfold'){
    in_train <- which(kfolds != i)
    }
  
    training <- data[ in_train, ]
    testing  <- data[-in_train, ]
    
    X_train <- training %>% dplyr::select(-all_of(target))
    y_train <- training[[target]] 
    
    X_test <- testing %>% dplyr::select(-all_of(target))
    y_test <- testing[[target]]
  
    
    #### LASSO
    # parameter tuning in inner loop
    mdl_enet_inner <- caret::train(X_train, y_train, method = "glmnet",
                                   preProcess = c("center", "scale"),
                                   trControl = ctrl, 
                                   tuneGrid = enet_grid)
  
    # fit model with best parameter settings to training set in outer loop
    mdl_enet_outer <- caret::train(X_train, y_train, method = "glmnet",
                                   preProcess = c("center", "scale"),
                                   tuneGrid = mdl_enet_inner$bestTune)
    
    # evaluate on test set in outer loop 
    y_pred_enet <- predict(mdl_enet_outer, newdata = X_test)
    eval_enet <- defaultSummary(data.frame(obs = y_test, pred = y_pred_enet))
    cor_acc <- cor(y_test, y_pred_enet)
    eval_enet = eval_enet %>% as.data.frame() %>% t() %>% cbind(cor_acc)
    cv_results[[1]] <-  cv_results[[1]] %>% rbind(eval_enet)
    
  
    #### random forest
    # parameter tuning in inner loop
    mdl_rf_inner <- caret::train(X_train, y_train, data = training, method = "rf",
                                 preProcess = c("center", "scale"),
                                 ntrees = 1000, importance = TRUE,
                                 tuneGrid = rf_grid,
                                 trControl = ctrl)
    
    # fit model with best parameter settings to training set in outer loop
    mdl_rf_outer <- caret::train(X_train, y_train, method = "rf",
                                 preProcess = c("center", "scale"),
                                 ntrees = 1000, importance = TRUE,
                                 tuneGrid = mdl_rf_inner$bestTune)
    
    # evaluate on test set in outer loop 
    y_pred_rf <- predict(mdl_rf_outer, newdata = X_test)
    eval_rf <- defaultSummary(data.frame(obs = y_test, pred = y_pred_rf))
    cor_acc <- cor(y_test, y_pred_rf)
    eval_rf = eval_rf %>% as.data.frame() %>% t() %>% cbind(cor_acc)
    cv_results[[2]] <-  cv_results[[2]] %>% rbind(eval_rf)
    
  }
  
  return(cv_results)

}

```

## Predict SC Scores From Aggregate Process Data
```{r}

sc_feat_all_pred_sc <- sc_feat_all %>% 
  dplyr::select(-c(pc, mr, VKMR, SPM, xPos_range, ray_x_range)) %>% 
  column_to_rownames("id")

cv_results_sc <- nested_cv(data = sc_feat_all_pred_sc, target = 'sc')

cv_results_sc$enet %>% as.data.frame() %>% map_dbl(mean)
cv_results_sc$rf %>% as.data.frame() %>% map_dbl(mean)

cv_results_sc$enet
cv_results_sc$rf
```



## Predict MR Scores From Aggregate Process Data
```{r}

sc_feat_all_pred_mr <- sc_feat_all %>% 
  dplyr::select(-c(pc, sc, SPM, VKMR, xPos_range, ray_x_range)) %>% 
  column_to_rownames("id")

cv_results_mr <- nested_cv(data = sc_feat_all_pred_mr, target = 'mr')

cv_results_mr$enet %>% as.data.frame() %>% replace( is.na(.), 0) %>% map_dbl(mean)
cv_results_mr$rf %>% as.data.frame() %>% replace( is.na(.), 0) %>% map_dbl(mean)
cv_results_mr

```

## Predict PC Scores From Aggregate Process Data
```{r}

sc_feat_all_pred_pc <- sc_feat_all %>% 
  dplyr::select(-c(mr, sc, SPM, VKMR, xPos_range, ray_x_range)) %>% 
  column_to_rownames("id")

cv_results_pc <- nested_cv(data = sc_feat_all_pred_pc, target = 'pc')

cv_results_pc$enet %>% as.data.frame() %>% replace( is.na(.), 0) %>% map_dbl(mean)
cv_results_pc$rf %>% as.data.frame() %>% replace( is.na(.), 0) %>% map_dbl(mean)


```


## Predict VKMR Scores From Aggregate Process Data
```{r}

sc_feat_all_pred_vkmr <- sc_feat_all %>% 
  dplyr::select(-c(pc, mr, sc, SPM, xPos_range, ray_x_range)) %>% 
  column_to_rownames("id")

cv_results_vkmr <- nested_cv(data = sc_feat_all_pred_vkmr, target = 'VKMR')

cv_results_vkmr$enet %>% as.data.frame() %>% map_dbl(mean)


```


## Predict SPM Scores From Aggregate Process Data
```{r}

sc_feat_all_pred_spm <- sc_feat_all %>% 
  dplyr::select(-c(pc, mr, sc, VKMR, xPos_range, ray_x_range)) %>% 
  column_to_rownames("id")

cv_results_spm <- nested_cv(data = sc_feat_all_pred_spm, target = 'SPM')

cv_results_spm$enet %>% as.data.frame() %>% replace( is.na(.), 0) %>% map_dbl(mean)


```




# Cluster Analysis of Solution Strategies 
```{r}

```





